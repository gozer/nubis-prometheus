groups:
- name: apache.prom
  rules:
  - record: apache:apache_accesses_total:rate5m
    expr: rate(apache_accesses_total[5m])
  - record: apache:apache_accesses_total:rate1h
    expr: rate(apache_accesses_total[1h])
  - record: apache:apache_sent_kilobytes_total:rate5m
    expr: rate(apache_sent_kilobytes_total[5m])
  - record: apache:apache_sent_kilobytes_total:rate1h
    expr: rate(apache_sent_kilobytes_total[1h])
  - alert: ApacheAccessSpike
    expr: (abs((apache:apache_accesses_total:rate5m > 1) - ON(job) GROUP_LEFT(project)
      avg(apache:apache_accesses_total:rate1h) BY (job)) > 0.05 > ON(job) GROUP_LEFT(project)
      (2 * stddev(apache:apache_accesses_total:rate1h) BY (job))) / ON(job) GROUP_LEFT()
      stddev(apache:apache_accesses_total:rate1h) BY (job) * ON(instance) GROUP_LEFT(project,
      arena, environment, account) nubis * ON(instance) GROUP_LEFT(instance_type,
      availability_zone, region) aws
    for: 15m
    labels:
      severity: critical
      type: anomaly
    annotations:
      description: '{{ $labels.instance }} is showing a request spike of {{ $value
        }} stddevs, more than 2 over the average'
      summary: Anomalous request spike on {{ $labels.instance }}
  - alert: ApacheSentKbSpike
    expr: (abs((apache:apache_sent_kilobytes_total:rate5m > 1) - ON(job) GROUP_LEFT(project)
      avg(apache:apache_sent_kilobytes_total:rate1h) BY (job)) > 0.05 > ON(job) GROUP_LEFT(project)
      (2 * stddev(apache:apache_sent_kilobytes_total:rate1h) BY (job))) / ON(job)
      GROUP_LEFT() stddev(apache:apache_sent_kilobytes_total:rate1h) BY (job) * ON(instance)
      GROUP_LEFT(project, arena, environment, account) nubis * ON(instance) GROUP_LEFT(instance_type,
      availability_zone, region) aws
    for: 15m
    labels:
      severity: critical
      type: anomaly
    annotations:
      description: '{{ $labels.instance }} is showing an outbount KBs spike of {{
        $value }} stddevs, more than 2 over the average'
      summary: Anomalous Outbound KBs spike on {{ $labels.instance }}
